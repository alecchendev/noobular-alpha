{% macro render_content(block) %}
<p class="content">{{ block.content }}</p>
{% endmacro %}

{% macro render_knowledge_point(course, lesson, block, block_index, question_index=0) %}
    {% if block.knowledge_point.questions and question_index < block.knowledge_point.questions|length %}
        {% set question = block.knowledge_point.questions[question_index] %}
        <div class="question">
            <p><strong>{{ question.prompt }}</strong></p>
            <form id="knowledge-point-{{ block_index }}-question-form-{{ question_index }}">
                {% for choice in question.choices %}
                    <label>
                        <input type="radio" name="answer" value="{{ loop.index0 }}" required>
                        {{ choice.text }}
                    </label><br>
                {% endfor %}
                <p><small>Question {{ question_index + 1 }} of {{ block.knowledge_point.questions|length }}</small></p>
            </form>
        </div>
        <button
            id="submit-button"
            type="submit"
            hx-post="/course/{{ course.route }}/lesson/{{ lesson.route }}/submit"
            hx-target="#submit-button"
            hx-vals='{"block_index": {{ block_index }}, "question_index": {{ question_index }}}'
            hx-include="#knowledge-point-{{ block_index }}-question-form-{{ question_index }}"
            hx-swap="outerHTML"
        >Submit</button>
    {% endif %}
{% endmacro %}

{% macro render_next_button(course, lesson, next_block_index, next_question_index) %}
<button
    id="submit-button"
    hx-post="/course/{{ course.route }}/lesson/{{ lesson.route }}/next"
    hx-target="#submit-button"
    hx-vals='{"block_index": {{ next_block_index }}, "question_index": {{ next_question_index }}}'
    hx-swap="outerHTML"
>Next</button>
{% endmacro %}

{% macro render_lesson_block(course, lesson, block_index, question_index) %}
{% set block = lesson.blocks[block_index] %}

{# Render the current block #}
{% if block.kind == "content" %}
    {{ render_content(block) }}
    {# For content blocks, show next button immediately #}
    {% if block_index < lesson.blocks|length - 1 %}
        {% set next_block_index = block_index + 1 %}
        {% set next_question_index = 0 %}
        {{ render_next_button(course, lesson, next_block_index, next_question_index) }}
    {% endif %}
{% elif block.kind == "knowledge_point" %}
    {{ render_knowledge_point(course, lesson, block, block_index, question_index) }}
    {# For knowledge points, next button is rendered after answer submission #}
{% endif %}
{% endmacro %}
