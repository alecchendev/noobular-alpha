{% extends 'base.html' %}

{% block title %}Quiz {{ quiz.id }} - {{ course.title }}{% endblock %}

{% block content %}
<h1>Quiz {{ quiz.id }}</h1>

{% if is_submitted %}
    <h2>Score: {{ score }}</h2>
    {% for question in quiz.questions %}
        <p>{{ loop.index }}. {{ question.prompt }}</p>
        {% for choice in question.choices %}
            <label>
                <input type="radio"
                       name="question_{{ question.id }}"
                       value="{{ choice.id }}"
                       {% if question.answer and question.answer.choice_id == choice.id %}checked{% endif %}
                       disabled>
                    {{ choice.text }}
            </label>
        {% endfor %}
        {% set is_correct = question.answer.choice_id == question.correct_choice().id %}
        {% set correct_answer_text = question.correct_choice().text %}
        {% set explanation = question.explanation %}
        {% include 'answer_feedback.html' %}
    {% endfor %}
{% else %}
    <p>Time remaining: <span id="timer"></span></p>

    <form id="quiz-form" method="POST" action="/course/{{ course.id }}/quiz/{{ quiz.id }}/submit">
        {% for question in quiz.questions %}
            <p>{{ loop.index }}. {{ question.prompt }}</p>
            {% for choice in question.choices %}
                <label>
                    <input type="radio" name="question_{{ question.id }}" value="{{ choice.id }}" {% if loop.first %}checked{% endif %} required>
                    {{ choice.text }}
                </label>
            {% endfor %}
        {% endfor %}
        <button type="submit">Submit Quiz</button>
    </form>
{% endif %}

<a class="back" href="/course/{{ course.id }}">‚Üê Back to Course</a>

<script>
    const startTime = {% if quiz.started_at %}new Date("{{ quiz.started_at }}".replace(' ', 'T') + 'Z').getTime(){% else %}Date.now(){% endif %};
    const timeLimitMs = {{ quiz_time_limit_minutes }} * 60 * 1000;
    const endTime = startTime + timeLimitMs;
    let submitted = {% if quiz.questions[0].answer %}true{% else %}false{% endif %};
    console.log("submitted:", submitted);

    function updateTimer() {
        const now = Date.now();
        const remaining = endTime - now;

        if (remaining <= 0) {
            console.log("got here");
            submitted = true;
            document.getElementById('timer').textContent = '0:00';
            document.getElementById('quiz-form').submit();
            return;
        }

        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        setTimeout(updateTimer, 1000);
    }

    if (!submitted) {
        updateTimer();
    }
</script>
{% endblock %}
