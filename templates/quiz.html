<!DOCTYPE html>
<html>
<head>
    {% include 'header.html' %}
    <title>Quiz {{ quiz.id }} - {{ course.title }}</title>
</head>
<body>
    <h1>Quiz {{ quiz.id }}</h1>

    {% if is_submitted %}
        <h2>Score: {{ score }}</h2>
        {% for question in quiz.questions %}
            <p>{{ loop.index }}. {{ question.prompt }}</p>
            {% for choice in question.choices %}
                <div>
                    <input type="radio"
                           name="question_{{ question.id }}"
                           value="{{ loop.index0 }}"
                           {% if question.answer and question.answer.choice_id == choice.id %}checked{% endif %}
                           disabled>
                    {% if question.answer and question.answer.choice_id == choice.id %}
                        {% if choice.correct %}
                            ✅ {{ choice.text }}
                        {% else %}
                            ❌ {{ choice.text }}
                        {% endif %}
                    {% elif choice.correct %}
                        ✓ {{ choice.text }}
                    {% else %}
                        {{ choice.text }}
                    {% endif %}
                </div>
            {% endfor %}
        {% endfor %}
    {% else %}
        <p>Time remaining: <span id="timer"></span></p>

        <form id="quiz-form" method="POST" action="/course/{{ course.id }}/quiz/{{ quiz.id }}/submit">
            {% for question in quiz.questions %}
                <p>{{ loop.index }}. {{ question.prompt }}</p>
                {% for choice in question.choices %}
                    <div>
                        <input type="radio" name="question_{{ question.id }}" value="{{ loop.index0 }}" required>
                        {{ choice.text }}
                    </div>
                {% endfor %}
            {% endfor %}
            <button type="submit">Submit Quiz</button>
        </form>
    {% endif %}

    <a class="back" href="/course/{{ course.id }}">← Back to Course</a>

    <script>
        const startTime = {% if quiz.started_at %}new Date("{{ quiz.started_at }}".replace(' ', 'T') + 'Z').getTime(){% else %}Date.now(){% endif %};
        const timeLimitMs = {{ quiz_time_limit_minutes }} * 60 * 1000;
        const endTime = startTime + timeLimitMs;
        let submitted = false;

        function updateTimer() {
            const now = Date.now();
            const remaining = endTime - now;

            if (remaining <= 0 && !submitted) {
                submitted = true;
                document.getElementById('timer').textContent = '0:00';
                htmx.trigger('#quiz-form', 'submit');
                clearInterval(timerInterval);
            } else {
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        updateTimer();
        const timerInterval = setInterval(updateTimer, 1000);
    </script>
</body>
</html>
